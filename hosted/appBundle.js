(()=>{"use strict";const e=(e,t,n)=>fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-Token":t._csrf},body:JSON.stringify(t)}).then((e=>a(e,n))),t=(e,t)=>fetch(e,{method:"GET",headers:{Accept:"application/json"}}).then((e=>a(e,t))),a=(e,t)=>e.ok?e.json():t(e.json()),n=e=>e.leaderboard?e.leaderboard.length<=0?React.createElement("div",null,React.createElement("div",{className:"row"},React.createElement("h4",null,"Leaderboard")),React.createElement("p",null,"This leaderboard has no records to show!")):React.createElement("div",null,React.createElement("div",{className:"row"},React.createElement("h4",null,"Leaderboard")),React.createElement("table",{className:"u-full-width"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Name"),React.createElement("th",null,"Type"),React.createElement("th",null,"Score"))),React.createElement("tbody",null,e.leaderboard.map((e=>React.createElement("tr",{key:e._id},React.createElement("td",null,e.name),React.createElement("td",null,e.type),React.createElement("td",null,e.score))))))):React.createElement("div",null,React.createElement("div",{className:"row"},React.createElement("h4",null,"Leaderboard")),React.createElement("p",null,"No leaderboards to show!"));let r,l,s;const c=e=>React.createElement("div",{className:"container"},React.createElement("h4",null,e.profile.username),React.createElement("h5",null,"Avatar: ",l?l.name:"Default",l?React.createElement("img",{src:"/assets/img/"+l.type+l.path+"/icon.png"}):""),React.createElement("h5",null,"Terrain Pack: ",s?s.name:"Default",s?React.createElement("img",{src:"/assets/img/"+s.type+s.path+"/icon.png"}):""),React.createElement("h5",null,"Owned Items"),React.createElement("div",{className:"u-full-width",id:"marketItems"}),React.createElement("button",{className:"button",onClick:y},"Change Password")),o=e=>!e.profile.ownedItems||e.profile.ownedItems<=0?React.createElement("div",null,React.createElement("p",null,"There are no items to show!")):e.profile.ownedItems.map((t=>React.createElement("div",{className:"marketItem",key:t._id},React.createElement("div",{className:"container"},React.createElement("img",{src:"/assets/img/"+t.type+t.path+"/icon.png"}),React.createElement("h5",null,t.name),m(e,t))))),i=e=>React.createElement("form",{id:"passwordForm",name:"passwordForm",onSubmit:h,action:"/password",method:"POST"},React.createElement("label",{htmlFor:"oldPassword"},"Old Password: "),React.createElement("input",{className:"u-full-width",type:"password",placeholder:"Enter old password...",name:"oldPassword"}),React.createElement("label",{htmlFor:"newPassword1"},"New Password: "),React.createElement("input",{className:"u-full-width",type:"password",placeholder:"Enter new password...",name:"newPassword1"}),React.createElement("label",{htmlFor:"newPassword2"},"Re-Enter New Password: "),React.createElement("input",{className:"u-full-width",type:"password",placeholder:"Re-Enter new password...",name:"newPassword2"}),React.createElement("p",{name:"errorMessage",className:"errorMessage"}),React.createElement("input",{type:"hidden",name:"_csrf",value:e.csrf}),React.createElement("input",{className:"button-primary",type:"submit",value:"Login"})),m=(t,a)=>a._id===r.equipedAvatar||a._id===r.equipedTerrain?React.createElement("button",{type:"button",className:"button"},"Equiped"):React.createElement("button",{type:"button",className:"button-primary",onClick:async n=>{await e("/equipItem",{id:a._id,type:a.type,_csrf:t.csrf}),p()}},"Equip"),d=async()=>{const e=await t("/getProfile");return r=e.profile,r.ownedItems.splice(0,0,{_id:"defaultavatar",name:"Default Avatar",type:"avatar",path:"/default"}),r.ownedItems.splice(1,0,{_id:"defaultterrain",name:"Default Terrain",type:"terrain",path:"/default"}),l=r.ownedItems.find((e=>e._id===r.equipedAvatar)),s=r.ownedItems.find((e=>e._id===r.equipedTerrain)),console.dir(l),l||(l=r.ownedItems[0]),s||(s=r.ownedItems[1]),r},h=async t=>{t.preventDefault();const a=t.target,n=a.elements.oldPassword.value,r=a.elements.newPassword1.value,l=a.elements.newPassword2.value,s=a.elements._csrf.value,c=a.querySelector(".errorMessage");return""===n||""===r||""===l?(c.textContent="Old Password and New Password are required!",!1):(c.textContent="",e("/password",{pass:n,newPass1:r,newPass2:l,_csrf:s},(e=>{e.then((e=>{c.textContent=e.error}))})).then((e=>{if(void 0===e)return!1;p()})),!1)},u=()=>t("/getToken"),p=async()=>{await d();const e=await u().then((e=>e.csrfToken));ReactDOM.render(React.createElement(c,{profile:r}),document.querySelector("#content")),ReactDOM.render(React.createElement(o,{profile:r,csrf:e}),document.querySelector("#marketItems"))},y=async()=>{const e=await u().then((e=>e.csrfToken));ReactDOM.render(React.createElement(i,{csrf:e}),document.querySelector("#content"))},R=e=>React.createElement("div",{className:"container"},React.createElement("div",{className:"row"},React.createElement("h4",{className:"one-half column"},"Ski Shop"),React.createElement("select",{id:"filterDropdown",onChange:t=>{f(t.target.value,e.csrf)}},React.createElement("option",{value:"unset"},"All"),React.createElement("option",{value:"terrain"},"Terrain Packs"),React.createElement("option",{value:"avatar"},"Avatars"))),React.createElement("div",{className:"u-full-width",id:"marketItems"})),E=e=>!e.market||e.market.length<=0?React.createElement("p",null,"Nothing was found in the Ski Shop!"):e.market.map((t=>React.createElement("div",{className:"marketItem",key:t._id},React.createElement("div",{className:"container"},React.createElement("img",{src:"/assets/img/"+t.type+t.path+"/icon.png"}),React.createElement("h5",null,t.name),w(e,t))))),w=(t,a)=>{let n=(e=>r.ownedItems.find((t=>t._id===e._id)))(a);return n?React.createElement("button",{type:"button",className:"button"},"Owned"):React.createElement("button",{type:"button",className:"button-primary",onClick:async n=>{await e("/buyItem",{id:a._id,_csrf:t.csrf}),f("unset",t.csrf)}},"Buy")},f=(e,a)=>{const n="/market"+("unset"!=e?"?filter="+e:"");console.dir("update"),t(n).then((async e=>{await d(),ReactDOM.render(React.createElement(E,{market:e.market,csrf:a}),document.querySelector("#marketItems"))}))};let g,x,v,k=0,b=0,N=10;const S=(e,t)=>{let a=e-k,n=t-b;return a=a/N*x,n=g.height-n/N*x,{x:a,y:n}},M=(e,t,a,n)=>{k+=(a-k)*e*t,b+=(n-b)*e*t},T={},C=e=>{T[e.key]=!0},I=e=>{T[e.key]=!1},P=e=>T[e],q=(e,t,a,n)=>Math.sqrt(Math.pow(a-e,2)+Math.pow(n-t,2)),O=(e,t)=>Math.sqrt(e*e+t*t),_=(e,t)=>{const a=O(e,t);return{x:e/a,y:t/a}};class D{constructor(e,t,a,n){this.name=e,this.x=t,this.y=a,this.avatar=n,this.movementSpeed=1,this.vx=0,this.vy=0,this.angle=0}update(e){if(this.dead)return;const t={x:Math.cos(this.angle+Math.PI/2),y:Math.sin(this.angle+Math.PI/2)},a=((e,t,a,n)=>{const r=O(e,t),l=O(e,t)*Math.cos(((e,t,a,n)=>Math.acos(((e,t,a,n)=>e*a+t*n)(e,t,a,n)/(O(e,t)*O(a,n))))(e,t,a,n));return{x:l*(a/r),y:l*(n/r)}})(0,10,t.x,t.y);P("a")&&(this.angle+=2*e),P("d")&&(this.angle-=2*e),P("s")&&this.addForce({x:.25*-this.vx,y:.25*-this.vy}),this.addForce({x:a.x,y:a.y}),this.addForce({x:.075*-this.vx,y:.075*-this.vy});let n=O(this.vx,this.vy);this.vx=t.x*n,this.vy=t.y*n,P("w")&&n<5&&(this.vx+=1.5*t.x,this.vy+=1.5*t.y),O(this.vx,this.vy)>.1&&(this.x+=this.vx*e,this.y+=this.vy*e)}addForce(e){this.vx+=e.x,this.vy+=e.y}draw(e){const t=S(this.x,this.y);S(this.x+.5,this.y-.5),e.save(),e.translate(t.x+v/2,t.y+v/2),e.rotate(-this.angle),e.translate(-(t.x+v/2),-(t.y+v/2)),e.drawImage(this.avatar,t.x,t.y,v,v),e.restore()}}class A{constructor(e,t,a=0,n=0,r=0){this.name=e,this.avatar=t,this.x=a,this.y=n,this.angle=r,this.actualX=a,this.actualY=n,this.actualAngle=r,this.lerpSpeed=10}update(e){this.x=this.actualX,this.y=this.actualY,this.angle=this.actualAngle}setActual(e,t,a){this.actualX=e,this.actualY=t,this.actualAngle=a}draw(e){const t=S(this.x,this.y);e.save(),e.fillStyle="black",e.font="20px Arial",e.textAlign="center",e.fillText(this.name,t.x+v/2,t.y+v+15),e.translate(t.x+v/2,t.y+v/2),e.rotate(this.angle),e.translate(-(t.x+v/2),-(t.y+v/2)),e.drawImage(this.avatar,t.x,t.y,v,v),e.restore()}}const F=16;class X{constructor(e,t){this.seed=e,this.spritesheet=t,this.lastChunkPos={x:-1,y:-1},this.chunks=[]}update(e,t){let a=this.asChunk(k,b);if(a.x!=this.lastChunkPos.x||a.y!=this.lastChunkPos.y){for(let e=-1;e<2;e++)for(let t=-1;t<2;t++){let n=a.x+e,r=a.y+t;this.chunks.find((e=>e.x==16*n&&e.y==16*r))||this.chunks.push(new B(n,r,0,this.spritesheet))}this.lastChunkPos.x=a.x,this.lastChunkPos.y=a.y;for(let e=0;e<this.chunks.length;e++){let t=this.chunks[e];q(t.x,t.y,k,b)>32&&(this.chunks.splice(e,1),e--)}this.chunks.sort(((e,t)=>t.y-e.y))}if(!t||t.dead)return;let n=this.asChunk(t.x+.5,t.y-.5),r=this.chunks.find((e=>e.x==16*n.x&&e.y==16*n.y));r&&r.tiles.forEach((e=>{e.perlin<.65||q(e.x+.5,e.y-1.5,t.x+.5,t.y-.5)<1&&ie()}))}asChunk(e,t){return{x:Math.floor(e/F),y:Math.floor(t/F)}}draw(e){for(let t=0;t<this.chunks.length;t++)this.chunks[t].draw(e)}}class B{constructor(e,t,a,n){this.x=e*F,this.y=t*F,this.seed=a,this.spritesheet=n,this.tiles=[];for(let e=0;e<F;e++)for(let t=0;t<F;t++){let a=t*F+e,n=this.x+e,r=this.y+t,l=r,s={x:-n,y:-r};s=_(s.x,s.y);let c=noise.perlin2(n/10,r/10)+.5;q(n,r,0,0)<10&&(c=0),this.tiles[a]=new Y(n,r,l,this.spritesheet,s,c)}this.tiles.sort(((e,t)=>t.y-e.y))}draw(e){this.tiles.forEach((t=>{t.draw(e)}))}altitude(e,t){let a=q(e,t,0,0);return a<10?0:(a-5)/5}}class Y{constructor(e,t,a,n,r,l){this.x=e,this.y=t,this.z=a,this.img=n,this.facing=r,this.perlin=l,this.sx=0,this.sy=0}draw(e){const t=S(this.x,this.y);if(S(this.x+.5,this.y-1.5),q(this.x,this.y,k,b)>15)return;e.save();const a={x:16,y:16};this.facing.x>0&&(a.x-=16),this.facing.x<0&&(a.x+=16),this.facing.y>0&&(a.y+=16),this.facing.y<0&&(a.y-=16),this.perlin>.65&&e.drawImage(this.img,48,0,16,32,t.x,t.y,v,2*v),e.restore()}}let j,L,z,G,H,J,$,K,Q={width:600,height:600},U={},V=[];const W=io();let Z,ee,te=!0,ae=0,ne=0;const re=e=>React.createElement("canvas",null,"Canvas needs to be supported!"),le=(e,t,a)=>{te=!0,ReactDOM.render(React.createElement(re,null),document.querySelector("#content")),ee=a,K=void 0,$=void 0,clearInterval(Z),document.onkeydown=C,document.onkeyup=I,noise.seed(t),J=e,W.emit("join room",e)};W.on("resume setup",(async e=>{let t=await(async()=>(r||await d(),s))();var a;G=await(async()=>(r||await d(),l))(),H=await(async()=>(r||await d(),r.username))(),z=new Image,z.src=`/assets/img/terrain${t.path}/spritesheet.png`,j=document.querySelector("canvas"),j.width=Q.width,j.height=Q.height,g=a=Q,N=10,x=a.width,v=x/10,k=0,b=0,L=j.getContext("2d"),L.imageSmoothingEnabled=!1,L.mozImageSmoothingEnabled=!1,L.webkitImageSmoothingEnabled=!1,L.msImageSmoothingEnabled=!1,$=new X(0,z),V=[],e.forEach((e=>{e.name!==H&&me(e.name,de(e.avatar),e.x,e.y)})),Z=setInterval(ce,1e3/60)}));let se=1/60;const ce=()=>{L.clearRect(0,0,Q.width,Q.height),K&&!K.dead?M(se,15,K.x+K.vx/2.5-4.5,K.y+K.vy/2.5-5.5):V.length>0&&M(se,5,V[0].x-4.5,V[0].y-5.5),$.update(se,K),K&&(K.update(se,W),K.draw(L),K.sentX==K.x&&K.sentY==K.y||(K.sentX=K.x,K.sentY=K.y,W.emit("move player",{room:J,name:K.name,x:K.sentX,y:K.sentY,angle:-K.angle}))),V.forEach((e=>{e.update(se),e.draw(L)})),$.draw(L),L.save(),L.fillStyle="black",L.strokeStyle="white",L.font="25px Arial",K&&!K.dead?(Math.round(K.y)>ne&&(ne=Math.round(K.y)),L.textAlign="end",L.strokeText("Score: "+ne,Q.width,25),L.fillText("Score: "+ne,Q.width,25)):(L.textAlign="center",L.strokeText("Score: "+ne,Q.width/2,Q.height/2-50),L.strokeText("High Score: "+ae,Q.width/2,Q.height/2-25),L.strokeText("Press Space to Respawn...",Q.width/2,Q.height/2),L.fillText("Score: "+ne,Q.width/2,Q.height/2-50),L.fillText("High Score: "+ae,Q.width/2,Q.height/2-25),L.fillText("Press Space to Respawn...",Q.width/2,Q.height/2),P(" ")&&W.emit("spawn player",{room:J,name:H,avatar:G.path})),L.restore()};W.on("spawn player",(e=>{e.name===H?oe(H,de(G.path)):me(e.name,de(e.avatar))})),W.on("remove player",(e=>{const t=V.indexOf(V.find((t=>t.socketId===e)));V.splice(t,1)})),W.on("move player",(e=>{const t=V.find((t=>t.name===e.name));t&&t.setActual(e.x,e.y,e.angle)}));const oe=(e,t)=>{let a=new D(e,0,0,t);ne=0,K=a},ie=()=>{ne>ae&&(ae=ne,e("/leaderboard",{name:H,type:"Alpine",score:ne,_csrf:ee})),W.emit("kill player",{room:J}),K.dead=!0},me=(e,t,a=0,n=0)=>{let r=new A(e,t,a,n);V.push(r)},de=e=>(U[e]||(U[e]=new Image,U[e].src=`/assets/img/avatar${e}/sprite.png`),U[e]),he=()=>{V=[],te=!1,W.emit("closed game")},ue=e=>React.createElement("div",{className:"container"},React.createElement("div",{className:"row",id:"headerBar"},React.createElement("button",{type:"button",className:"button",id:"marketButton",onClick:()=>{console.dir("clicked market"),(async()=>{ReactDOM.render(React.createElement(R,null),document.querySelector("#content"));const e=await t("/getToken").then((e=>e.csrfToken)),a=await t("/market");await d(),ReactDOM.render(React.createElement(R,{csrf:e}),document.querySelector("#content")),ReactDOM.render(React.createElement(E,{market:a.market,csrf:e}),document.querySelector("#marketItems"))})(),he()}},"Market"),React.createElement("button",{type:"button",className:"button",id:"leaderboardButton",onClick:()=>{console.dir("clicked leaderboard"),ReactDOM.render(React.createElement(n,null),document.querySelector("#content")),t("/leaderboard").then((e=>{ReactDOM.render(React.createElement(n,{leaderboard:e.leaderboard}),document.querySelector("#content"))})),he()}},"Leaderboards"),React.createElement("button",{type:"button",className:"button",id:"gameButton",onClick:()=>{console.dir("clicked game"),fe(),he()}},"Game"),React.createElement("button",{type:"button",className:"button",id:"profileButton",onClick:()=>{console.dir("clicked profile"),p(),he()}},"Profile"))),pe=e=>!e.slopes||e.slopes.length<=0?React.createElement("div",{className:"u-full-width"},React.createElement("div",{className:"row"},React.createElement("h4",{className:"one-half column"},"Open Resorts"),React.createElement("div",{className:"one-half column"},React.createElement("a",{className:"button",onClick:we},"Refresh"))),React.createElement("table",{className:"u-full-width"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Resort Name"),React.createElement("th",null,"Terrain Type"),React.createElement("th",null,"Skiier Count"),React.createElement("th",null,React.createElement("a",{className:"button button-primary",onClick:Ee},"Open Resort")))),React.createElement("tbody",null,React.createElement("tr",null,React.createElement("td",null,"No open resorts!"),React.createElement("td",null),React.createElement("td",null),React.createElement("td",null))))):React.createElement("div",null,React.createElement("div",{className:"row"},React.createElement("h4",{className:"one-half column"},"Open Resorts"),React.createElement("div",{className:"one-half column"},React.createElement("a",{className:"button",onClick:we},"Refresh"))),React.createElement("table",{className:"u-full-width"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"Resort Name"),React.createElement("th",null,"Terrain Type"),React.createElement("th",null,"Skiier Count"),React.createElement("th",null,React.createElement("button",{type:"button",className:"button-primary",onClick:Ee},"Open Resort")))),React.createElement("tbody",null,e.slopes.map((e=>React.createElement("tr",{key:e.id},React.createElement("td",null,e.name),React.createElement("td",null,e.type),React.createElement("td",null,e.players.length),React.createElement("td",null,React.createElement("button",{type:"button",className:"button",onClick:async()=>{let a=await t("/getSlope?id="+e.id);const n=await Re().then((e=>e.csrfToken));le(a.slope.id,a.slope.seed,n)}},"Join Slope")))))))),ye=t=>React.createElement("div",null,React.createElement("h4",null,"Open Resort"),React.createElement("label",{htmlFor:"resortName"},"Resort Name:"),React.createElement("input",{type:"text",id:"resortName",placeholder:"Enter resort name here..."}),React.createElement("p",{name:"errorMessage",className:"errorMessage"}),React.createElement("button",{className:"button-primary",onClick:async()=>{const a=document.querySelector(".errorMessage"),n={name:document.querySelector("#resortName").value,type:"Alpine",_csrf:t.csrf},r=await e("/createResort",n,(e=>{e.then((e=>{a.textContent=e.error}))}));r.err||le(r.resort.id,r.resort.seed,t.csrf)}},"Open Resort!")),Re=()=>t("/getToken"),Ee=async()=>{const e=await Re().then((e=>e.csrfToken));ReactDOM.render(React.createElement(ye,{csrf:e}),document.querySelector("#content"))},we=()=>{ReactDOM.render(React.createElement(pe,null),document.querySelector("#content")),t("/slopes").then((e=>{console.dir(e.slopes),ReactDOM.render(React.createElement(pe,{slopes:e.slopes}),document.querySelector("#content"))}))},fe=()=>{ReactDOM.render(React.createElement(ue,null),document.querySelector("#header")),we()};window.onload=()=>{fe()}})();